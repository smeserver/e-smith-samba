Index: e-smith-samba/e-smith-samba.spec
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/01access:1.1.1.1 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/01access:1.2
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/01access:1.1.1.1	Tue Mar 12 17:19:39 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/01access	Thu Feb 17 18:04:02 2005
@@ -1,8 +1,8 @@
 {
     $OUT = '';
 
-    my %networks;
-    tie %networks, 'esmith::config', '/home/e-smith/networks';
+    use esmith::NetworksDB;
+    my %networks = esmith::NetworksDB->as_hash;
 
     @access = esmith::util::computeLocalAccessSpec( $LocalIP,
                       $LocalNetmask, \%networks, 'private');
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11addUserScript
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11addUserScript:1.4 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11addUserScript:removed
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11addUserScript:1.4	Tue Apr  9 16:20:44 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11addUserScript	Wed Dec 31 19:00:00 1969
@@ -1,4 +0,0 @@
-{
-# Added for correct Windows domain user account set up
-}
-add user script = /sbin/e-smith/signal-event machine-account-create '%u'
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11characterSet
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11characterSet:1.1.1.1 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11characterSet:removed
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11characterSet:1.1.1.1	Tue Mar 12 17:19:38 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11characterSet	Wed Dec 31 19:00:00 1969
@@ -1,8 +0,0 @@
-{
-    local %services = ( smb => $smb );
-
-    my $characterSet = 
-	db_get_prop(\%services, "smb", "CharacterSet") || "ISO8859-1";
-
-    "character set = $characterSet";
-}
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11clientCodePage
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11clientCodePage:1.1.1.1 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11clientCodePage:removed
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11clientCodePage:1.1.1.1	Tue Mar 12 17:19:38 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11clientCodePage	Wed Dec 31 19:00:00 1969
@@ -1,8 +0,0 @@
-{
-    local %services = ( smb => $smb );
-
-    my $clientCodePage = 
-	db_get_prop(\%services, "smb", "ClientCodePage") || "850";
-
-    "client code page = $clientCodePage";
-}
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11dosCharSet
diff -u /dev/null e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11dosCharSet:1.1
--- /dev/null	Thu Feb 17 18:04:36 2005
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11dosCharSet	Thu Feb 17 18:04:02 2005
@@ -0,0 +1,5 @@
+{
+    my $DosCharSet = $smb{'DosCharSet'} || "850";
+
+    "dos charset = $DosCharSet";
+}
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonHome
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonHome:1.5 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonHome:1.6
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonHome:1.5	Wed Jun 18 16:32:48 2003
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonHome	Thu Feb 17 18:04:02 2005
@@ -7,11 +7,12 @@
 # Win9x uses logon home
 
     return "" unless ($SMB_DomainMaster eq "yes");
-
-    my $default = (db_get_prop($confref, 'smb', 'RoamingProfiles') eq "yes")
-		? '\\\%L\%U\._winprofile' : '';
-
-    my $logonHome = db_get_prop($confref, "smb", "LogonHome") || $default;
+    
+    my $roamingProfiles = $smb{RoamingProfiles} || "no";  
+  
+    my $default = ($roamingProfiles eq "yes") ? '\\\%L\%U\._winprofile' : '';
+    
+    my $logonHome = $smb{LogonHome} || $default;
 
     return "" unless $logonHome;
 
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonPath
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonPath:1.6 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonPath:1.7
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonPath:1.6	Wed Sep 10 17:51:37 2003
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11logonPath	Thu Feb 17 18:04:02 2005
@@ -8,10 +8,11 @@
 
     return "" unless ($SMB_DomainMaster eq "yes");
 
-    my $default = (db_get_prop($confref, 'smb', 'RoamingProfiles') eq "yes")
-		? '\\\%L\Profiles\%U' : '';
+    my $roamingProfiles = $smb{RoamingProfiles} || "no";
 
-    my $logonPath = db_get_prop($confref, "smb", "LogonPath") || $default;
+    my $default = ($roamingProfiles eq "yes") ? '\\\%L\Profiles\%U' : '';
+
+    my $logonPath = $smb{LogonPath} || $default;
 
     return "logon path = $logonPath";
 }
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11netbiosName
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11netbiosName:1.1.1.1 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11netbiosName:1.2
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11netbiosName:1.1.1.1	Tue Mar 12 17:19:38 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11netbiosName	Thu Feb 17 18:04:02 2005
@@ -1,4 +1,4 @@
 {
 # this  sets the NetBIOS name by which a Samba server is known
 }
-netbios name = { db_get_prop($confref, "smb", "ServerName") }
+netbios name = { $smb{ServerName} }
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11osLevel
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11osLevel:1.3 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11osLevel:1.4
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11osLevel:1.3	Wed Jun 18 16:32:48 2003
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11osLevel	Thu Feb 17 18:04:02 2005
@@ -5,7 +5,7 @@
 
     return "" unless ($SMB_DomainMaster eq "yes");
 
-    my $os_level = db_get_prop($confref, 'smb', 'OsLevel') || "65";
+    my $os_level = $smb{OsLevel} || "65";
 
     "os level = ${os_level}";
 }
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11passdbBackend
diff -u /dev/null e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11passdbBackend:1.1
--- /dev/null	Thu Feb 17 18:04:36 2005
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11passdbBackend	Thu Feb 17 18:04:02 2005
@@ -0,0 +1,4 @@
+{
+#Set the Samba user account dbase backend
+}
+passdb backend = smbpasswd:/etc/samba/smbpasswd
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11serverString
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11serverString:1.1.1.1 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11serverString:1.2
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11serverString:1.1.1.1	Tue Mar 12 17:19:39 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11serverString	Thu Feb 17 18:04:02 2005
@@ -1,8 +1,7 @@
 {
 # server string is the equivalent of the NT Description field
 
-   my $server_string = db_get_prop($confref, 'smb', 'ServerString') ||
-			   'Mitel Networks SME Server';
+   my $server_string = $set{ServerString} || 'SME Server';
 
    "server string = $server_string";
 }
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11unixCharSet
diff -u /dev/null e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11unixCharSet:1.1
--- /dev/null	Thu Feb 17 18:04:36 2005
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11unixCharSet	Thu Feb 17 18:04:02 2005
@@ -0,0 +1,5 @@
+{
+    my $UnixCharSet = $smb{'UnixCharSet'} || "ISO8859-1";
+
+    "unix charset = $UnixCharSet";
+}
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11workgroup
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11workgroup:1.1.1.1 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11workgroup:1.2
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11workgroup:1.1.1.1	Tue Mar 12 17:19:38 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/11workgroup	Thu Feb 17 18:04:02 2005
@@ -1,4 +1,4 @@
 {
 # workgroup = NT-Domain-Name or Workgroup-Name
 }
-workgroup = { db_get_prop($confref, "smb", "Workgroup") }
+workgroup = { $smb{Workgroup} }
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61Profilesshare
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61Profilesshare:1.3 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61Profilesshare:1.4
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61Profilesshare:1.3	Mon Jun  3 19:50:33 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61Profilesshare	Thu Feb 17 18:04:02 2005
@@ -2,10 +2,8 @@
 # This is the WinNT/W2K Profiles share
 # WinNT/W2K profiles are stored in /home/e-smith/files/samba/profiles/~user
 # Win9x profiles are stored in ~user/._winprofile
-    local %services = ( smb => $smb );
-
-    return "" 
-        unless (db_get_prop(\%services, "smb", "RoamingProfiles") eq "yes");
+    return ""
+	unless ($smb{RoamingProfiles} eq "yes");
 
     $OUT .= <<HERE;
 [Profiles]
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61printerdriversshare
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61printerdriversshare:1.3 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61printerdriversshare:1.4
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61printerdriversshare:1.3	Tue Nov 25 11:51:19 2003
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/61printerdriversshare	Thu Feb 17 18:04:02 2005
@@ -8,3 +8,4 @@
 guest ok = yes
 browsable = yes
 writable = yes
+use client driver = yes
Index: e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/90ibays
diff -u e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/90ibays:1.4 e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/90ibays:1.5
--- e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/90ibays:1.4	Thu Sep 19 15:12:20 2002
+++ e-smith-samba/root/etc/e-smith/templates/etc/smb.conf/90ibays	Thu Feb 17 18:04:02 2005
@@ -4,79 +4,15 @@
     use esmith::AccountsDB;
     my $adb = esmith::AccountsDB->open_ro();
 
-    my $result = "";
-
     foreach my $ibay ($adb->ibays)
     {
-	my %properties = $ibay->props;
-	my $key = $ibay->key;
-	$result .= "\n";
-	$result .= "[$key]\n";
-	$result .= "comment = $properties{'Name'}\n";
-
-	#---------------------------------------
-	# If no public access, have the share go directly to the files
-	# subdirectory (for easier drive mappings)
-	# Otherwise, have the share mapping show all three subfolders
-	#---------------------------------------
-
-	if ($properties{'PublicAccess'} eq 'none')
-	{
-	    $result .= "path = /home/e-smith/files/ibays/$key/files\n";
-	}
-	else
-	{
-	    $result .= "path = /home/e-smith/files/ibays/$key\n";
-	}
-
-	$result .= "read only = no\n";
-	$result .= "writable = yes\n";
-	$result .= "printable = no\n";
-
-	# Make the defaults really stupid
-	my $fmode = "0000";
-
-	if ($properties{'UserAccess'})
-	{
-	    #----------------------------------------
-	    # e-smith 4.0
-	    #----------------------------------------
-
-	    if ($properties{'UserAccess'} eq 'wr-admin-rd-group')
+	$OUT .= esmith::templates::processTemplate (
 	    {
-		$fmode = "0640";
-	    }
-	    elsif ($properties{'UserAccess'} eq 'wr-group-rd-group')
-	    {
-		$fmode = "0660";
-	    }
-	    elsif ($properties{'UserAccess'} eq 'wr-group-rd-everyone')
-	    {
-		$fmode = "0664";
-	    }
-	    $result .= "inherit permissions = yes\n";
-	}
-	else
-	{
-	    #----------------------------------------
-	    # e-smith 3.0
-	    #----------------------------------------
-
-	    my $dmode;
-	    if ($properties{'WriteAccess'} eq 'admin')
-	    {
-		$fmode = "0640";
-		$dmode = "0750";
-	    }
-	    else
-	    {
-		$fmode = "0660";
-		$dmode = "0770";
-	    }
-	    $result .= "directory mode = $dmode\n";
-	}
-	$result .= "create mode = $fmode\n";
+		MORE_DATA => {
+			ibay => $ibay,
+		    },
+		TEMPLATE_PATH => "/etc/smb.conf/ibays",
+		OUTPUT_TYPE => 'string',
+	    });
     }
-
-    return $result;
 }
Index: e-smith-samba/root/etc/rc.d/init.d/supervise/smb
diff -u e-smith-samba/root/etc/rc.d/init.d/supervise/smb:1.1 e-smith-samba/root/etc/rc.d/init.d/supervise/smb:1.2
--- e-smith-samba/root/etc/rc.d/init.d/supervise/smb:1.1	Tue Nov 18 15:23:27 2003
+++ e-smith-samba/root/etc/rc.d/init.d/supervise/smb	Thu Feb 17 18:04:02 2005
@@ -50,7 +50,7 @@
 	;;
 esac
 
-$smbd $1 || exit 1
 $nmbd $1 || exit 1
+$smbd $1 || exit 1
 
 exit 0
